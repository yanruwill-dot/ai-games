<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¤§æ˜1566 Â· å®«å»·é£äº‘</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=Ma+Shan+Zheng&display=swap');
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --gold: #c9a84c; --dark-gold: #8b6914; --crimson: #8b0000;
  --imperial-red: #c41e3a; --jade: #00a86b; --ink: #1a1a2e;
  --parchment: #f5e6c8; --dark-bg: #0a0a12; --panel-bg: rgba(10,10,18,0.92);
}
html, body { width:100%; height:100%; overflow:hidden; font-family:'Noto Serif SC',serif; }
body { background: var(--dark-bg); color: var(--parchment); }

/* ===== å…¨å±å®¹å™¨ ===== */
#game-container {
  width:100vw; height:100vh; position:relative; overflow:hidden;
  background: linear-gradient(180deg, #0d0d1a 0%, #1a0a0a 50%, #0d0d1a 100%);
}

/* ===== èƒŒæ™¯åœºæ™¯ ===== */
#scene-bg {
  position:absolute; inset:0; z-index:0; transition: opacity 1.2s ease;
  background-size:cover; background-position:center;
}

/* ===== ç²’å­/çƒŸé›¾ ===== */
.fog-overlay {
  position:absolute; inset:0; z-index:1;
  background: radial-gradient(ellipse at 50% 100%, rgba(139,105,20,0.08) 0%, transparent 70%);
  pointer-events:none;
}

/* ===== æ ‡é¢˜ç”»é¢ ===== */
#title-screen {
  position:absolute; inset:0; z-index:100; display:flex; align-items:center; justify-content:center;
  background: radial-gradient(ellipse at center, rgba(26,10,10,0.9) 0%, rgba(10,10,18,0.98) 100%);
  animation: titleFadeIn 2s ease;
}
@keyframes titleFadeIn { from{opacity:0} to{opacity:1} }
.title-content { text-align:center; }
.title-seal {
  width:120px; height:120px; margin:0 auto 30px; border:3px solid var(--crimson);
  display:flex; align-items:center; justify-content:center;
  font-family:'Ma Shan Zheng',cursive; font-size:60px; color:var(--crimson);
  transform:rotate(-5deg); border-radius:8px;
  box-shadow: 0 0 30px rgba(139,0,0,0.3), inset 0 0 20px rgba(139,0,0,0.1);
  animation: sealPulse 3s ease-in-out infinite;
}
@keyframes sealPulse { 0%,100%{box-shadow:0 0 30px rgba(139,0,0,0.3)} 50%{box-shadow:0 0 50px rgba(139,0,0,0.5)} }
.title-main {
  font-family:'Ma Shan Zheng',cursive; font-size:72px; color:var(--gold);
  text-shadow: 0 0 40px rgba(201,168,76,0.3), 2px 2px 4px rgba(0,0,0,0.8);
  letter-spacing:12px; margin-bottom:10px;
}
.title-sub {
  font-size:24px; color:var(--parchment); letter-spacing:20px; opacity:0.7; margin-bottom:30px;
}
.title-quote {
  font-style:italic; color:var(--gold); opacity:0.5; margin-bottom:40px;
  font-size:16px; letter-spacing:2px;
}
.btn-start {
  padding:14px 50px; font-size:18px; font-family:'Noto Serif SC',serif;
  background:transparent; color:var(--gold); border:1px solid var(--gold);
  cursor:pointer; letter-spacing:8px; transition:all 0.4s; margin:0 10px;
  position:relative; overflow:hidden;
}
.btn-start:hover {
  background:var(--gold); color:var(--dark-bg);
  box-shadow:0 0 30px rgba(201,168,76,0.3);
}
.btn-secondary { border-color:rgba(201,168,76,0.4); color:rgba(201,168,76,0.6); }
.btn-secondary:hover { background:rgba(201,168,76,0.15); color:var(--gold); }

/* ===== æ¸¸æˆä¸»ç•Œé¢ ===== */
#game-ui { position:absolute; inset:0; z-index:10; display:none; }

/* é¡¶éƒ¨çŠ¶æ€æ  */
#status-bar {
  position:absolute; top:0; left:0; right:0; z-index:20;
  padding:10px 24px; display:flex; justify-content:space-between; align-items:center;
  background:linear-gradient(180deg, rgba(0,0,0,0.7) 0%, transparent 100%);
}
.status-left, .status-right { display:flex; gap:16px; align-items:center; }
.stat-item {
  font-size:12px; color:var(--parchment); opacity:0.8; display:flex; align-items:center; gap:4px;
}
.stat-icon { font-size:14px; }
.stat-bar {
  width:60px; height:4px; background:rgba(255,255,255,0.1); border-radius:2px; overflow:hidden;
}
.stat-fill { height:100%; border-radius:2px; transition:width 0.6s ease; }
.stat-fill.power { background:var(--imperial-red); }
.stat-fill.wisdom { background:var(--jade); }
.stat-fill.loyalty { background:var(--gold); }
#chapter-title { font-size:13px; color:var(--gold); letter-spacing:4px; opacity:0.9; }

/* è§’è‰²ç«‹ç»˜åŒº */
#character-area {
  position:absolute; bottom:220px; left:0; right:0; height:calc(100% - 280px);
  display:flex; justify-content:center; align-items:flex-end; z-index:5;
  pointer-events:none;
}
.character-sprite {
  position:absolute; bottom:0; transition:all 0.8s cubic-bezier(0.25,0.46,0.45,0.94);
  filter:drop-shadow(0 0 20px rgba(0,0,0,0.5));
}
.char-left { left:5%; }
.char-center { left:50%; transform:translateX(-50%); }
.char-right { right:5%; }

/* è§’è‰²åç‰Œ */
.char-portrait {
  width:100%; height:100%; display:flex; flex-direction:column;
  align-items:center; justify-content:flex-end;
}
.char-avatar {
  width:180px; height:280px; border-radius:8px; overflow:hidden;
  background:linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.3) 100%);
  display:flex; align-items:center; justify-content:center;
  font-size:100px; position:relative;
}
.char-avatar::after {
  content:''; position:absolute; inset:0;
  border:1px solid rgba(201,168,76,0.2); border-radius:8px;
}

/* ===== å¯¹è¯æ¡† ===== */
#dialogue-box {
  position:absolute; bottom:0; left:0; right:0; z-index:15;
  background:linear-gradient(180deg, transparent 0%, rgba(10,10,18,0.95) 15%, rgba(10,10,18,0.98) 100%);
  padding:30px 40px 30px; min-height:220px;
  border-top:1px solid rgba(201,168,76,0.15);
}
#speaker-name {
  font-size:16px; color:var(--gold); letter-spacing:4px; margin-bottom:12px;
  padding-left:2px; font-weight:700;
  text-shadow:0 0 10px rgba(201,168,76,0.3);
}
#dialogue-text {
  font-size:17px; line-height:1.9; color:var(--parchment); max-width:900px;
  min-height:60px; letter-spacing:1px;
}
#dialogue-text .char { opacity:0; animation:charFade 0.03s forwards; }
@keyframes charFade { to{opacity:1} }

/* ç‚¹å‡»ç»§ç»­æç¤º */
#continue-hint {
  position:absolute; bottom:12px; right:40px; font-size:12px;
  color:var(--gold); opacity:0; animation:hintBlink 1.5s ease-in-out infinite;
  letter-spacing:2px;
}
@keyframes hintBlink { 0%,100%{opacity:0} 50%{opacity:0.6} }
#continue-hint.show { animation:hintBlink 1.5s ease-in-out infinite; }

/* ===== é€‰é¡¹ ===== */
#choices-container {
  position:absolute; bottom:0; left:0; right:0; z-index:20;
  display:none; padding:30px 40px 40px;
  background:linear-gradient(180deg, transparent 0%, rgba(10,10,18,0.97) 20%);
}
#choices-container h3 {
  font-size:14px; color:var(--gold); letter-spacing:4px; margin-bottom:16px; opacity:0.7;
}
.choice-btn {
  display:block; width:100%; max-width:700px; margin:0 auto 12px; padding:16px 24px;
  background:rgba(201,168,76,0.05); border:1px solid rgba(201,168,76,0.2);
  color:var(--parchment); font-size:16px; font-family:'Noto Serif SC',serif;
  cursor:pointer; text-align:left; transition:all 0.3s; letter-spacing:1px;
  position:relative; overflow:hidden;
}
.choice-btn::before {
  content:''; position:absolute; left:0; top:0; bottom:0; width:3px;
  background:var(--gold); opacity:0; transition:opacity 0.3s;
}
.choice-btn:hover {
  background:rgba(201,168,76,0.12); border-color:var(--gold);
  transform:translateX(4px); box-shadow:0 0 20px rgba(201,168,76,0.1);
}
.choice-btn:hover::before { opacity:1; }
.choice-tag {
  font-size:11px; color:var(--gold); opacity:0.5; margin-left:8px;
  letter-spacing:0;
}

/* ===== åºç« /è¿‡åœº ===== */
#prologue-screen {
  position:absolute; inset:0; z-index:90; display:none;
  background:var(--dark-bg); overflow-y:auto;
}
.prologue-content {
  max-width:700px; margin:0 auto; padding:60px 30px;
  font-size:17px; line-height:2.2; color:var(--parchment); opacity:0.85;
  letter-spacing:1px;
}
.prologue-content h2 {
  font-family:'Ma Shan Zheng',cursive; font-size:36px; color:var(--gold);
  text-align:center; margin-bottom:40px; letter-spacing:8px;
}
.prologue-content p { margin-bottom:20px; text-indent:2em; }
.prologue-content .center { text-align:center; text-indent:0; }
.prologue-content .gold { color:var(--gold); }
.prologue-btn {
  display:block; margin:40px auto 0; padding:12px 40px;
  background:transparent; border:1px solid var(--gold); color:var(--gold);
  font-size:16px; font-family:'Noto Serif SC',serif; cursor:pointer;
  letter-spacing:6px; transition:all 0.3s;
}
.prologue-btn:hover { background:var(--gold); color:var(--dark-bg); }

/* ===== ç« èŠ‚è¿‡æ¸¡ ===== */
#chapter-transition {
  position:absolute; inset:0; z-index:80; display:none;
  background:var(--dark-bg); flex-direction:column;
  align-items:center; justify-content:center;
}
#chapter-transition .ch-num {
  font-size:14px; color:var(--gold); letter-spacing:8px; opacity:0.5; margin-bottom:16px;
}
#chapter-transition .ch-title {
  font-family:'Ma Shan Zheng',cursive; font-size:48px; color:var(--gold);
  letter-spacing:8px; text-shadow:0 0 40px rgba(201,168,76,0.2);
}
#chapter-transition .ch-desc {
  margin-top:16px; font-size:15px; color:var(--parchment); opacity:0.5;
  letter-spacing:3px;
}

/* ===== ç»“å±€ç”»é¢ ===== */
#ending-screen {
  position:absolute; inset:0; z-index:85; display:none;
  background:radial-gradient(ellipse at center, rgba(26,10,10,0.95), rgba(10,10,18,0.99));
  flex-direction:column; align-items:center; justify-content:center;
}
.ending-label { font-size:14px; color:var(--gold); letter-spacing:8px; opacity:0.5; margin-bottom:20px; }
.ending-title {
  font-family:'Ma Shan Zheng',cursive; font-size:52px; color:var(--gold);
  letter-spacing:6px; margin-bottom:16px;
  text-shadow:0 0 40px rgba(201,168,76,0.3);
}
.ending-desc {
  max-width:600px; text-align:center; font-size:16px; line-height:2;
  color:var(--parchment); opacity:0.7; margin-bottom:40px;
}
.ending-poem {
  font-family:'Ma Shan Zheng',cursive; font-size:22px; color:var(--gold);
  opacity:0.6; line-height:2; text-align:center; margin-bottom:40px;
}

/* ===== åœºæ™¯èƒŒæ™¯é¢„è®¾ ===== */
.scene-palace {
  background:linear-gradient(180deg, #0d0a1a 0%, #1a0f0a 40%, #2a1a0a 70%, #1a0f0a 100%);
}
.scene-palace::before {
  content:''; position:absolute; inset:0;
  background:
    radial-gradient(ellipse at 50% 30%, rgba(201,168,76,0.06) 0%, transparent 50%),
    radial-gradient(ellipse at 20% 80%, rgba(139,0,0,0.05) 0%, transparent 40%),
    radial-gradient(ellipse at 80% 80%, rgba(139,0,0,0.05) 0%, transparent 40%);
}
.scene-study {
  background:linear-gradient(180deg, #0a0d1a 0%, #0f1520 40%, #1a1510 70%, #0f0d0a 100%);
}
.scene-garden {
  background:linear-gradient(180deg, #0a1a0d 0%, #0d1a10 40%, #1a2a15 60%, #0d150a 100%);
}
.scene-night {
  background:linear-gradient(180deg, #050510 0%, #0a0a1a 40%, #0d0d20 70%, #050510 100%);
}
.scene-court {
  background:linear-gradient(180deg, #1a0a0a 0%, #2a1010 30%, #3a1515 50%, #2a1010 70%, #1a0a0a 100%);
}
.scene-court::before {
  content:''; position:absolute; inset:0;
  background:
    radial-gradient(ellipse at 50% 20%, rgba(201,168,76,0.1) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 90%, rgba(139,0,0,0.08) 0%, transparent 40%);
}

/* ===== åŠ¨ç”» ===== */
.fade-in { animation:fadeIn 0.8s ease forwards; }
.fade-out { animation:fadeOut 0.6s ease forwards; }
@keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
@keyframes fadeOut { from{opacity:1} to{opacity:0} }

/* ===== å­˜æ¡£/èœå•æŒ‰é’® ===== */
.menu-btn {
  background:none; border:none; color:var(--gold); opacity:0.5;
  cursor:pointer; font-size:12px; letter-spacing:2px; transition:opacity 0.3s;
  font-family:'Noto Serif SC',serif;
}
.menu-btn:hover { opacity:1; }

/* ===== å…³ç³»é¢æ¿ ===== */
#relation-panel {
  position:absolute; top:50px; right:20px; z-index:25;
  background:var(--panel-bg); border:1px solid rgba(201,168,76,0.15);
  padding:16px 20px; border-radius:4px; display:none; min-width:200px;
}
#relation-panel h4 {
  font-size:13px; color:var(--gold); letter-spacing:3px; margin-bottom:12px;
}
.rel-item {
  display:flex; justify-content:space-between; align-items:center;
  padding:6px 0; font-size:13px; border-bottom:1px solid rgba(255,255,255,0.05);
}
.rel-name { color:var(--parchment); }
.rel-value { color:var(--gold); font-size:12px; }
.rel-value.high { color:var(--jade); }
.rel-value.low { color:var(--imperial-red); }

/* ===== å“åº”å¼ ===== */
@media(max-width:768px) {
  .title-main { font-size:42px; letter-spacing:6px; }
  .title-seal { width:80px; height:80px; font-size:40px; }
  #dialogue-box { padding:20px 20px 24px; min-height:180px; }
  #dialogue-text { font-size:15px; }
  .choice-btn { font-size:14px; padding:12px 16px; }
  .char-avatar { width:120px; height:200px; font-size:70px; }
}
</style>
</head>
<body>
<div id="game-container">
  <div id="scene-bg"></div>
  <canvas id="particles" style="position:absolute;inset:0;z-index:1;pointer-events:none;"></canvas>

  <!-- æ ‡é¢˜ç”»é¢ -->
  <div id="title-screen">
    <div class="title-content">
      <div class="title-seal">æ˜</div>
      <h1 class="title-main">å¤§æ˜ä¸€äº”å…­å…­</h1>
      <p class="title-sub">å®« å»· é£ äº‘</p>
      <div class="title-quote">"è¿™å¤§æ˜çš„å¤©ä¸‹ï¼Œæ˜¯æœ•çš„å¤©ä¸‹ã€‚"</div>
      <button class="btn-start" onclick="startGame()">å¼€ å§‹ æ¸¸ æˆ</button>
      <button class="btn-start btn-secondary" onclick="showPrologue()">åº ç« </button>
    </div>
  </div>

  <!-- åºç«  -->
  <div id="prologue-screen">
    <div class="prologue-content">
      <h2>åº Â· å˜‰é–å››åäº”å¹´</h2>
      <p>å˜‰é–å››åäº”å¹´ï¼Œå†¬ã€‚</p>
      <p>å¤§æ˜ç‹æœå·²èµ°è¿‡è¿‘ä¸¤ç™¾å¹´ã€‚ç´«ç¦åŸçš„ç‰ç’ƒç“¦ä¸‹ï¼Œä¸€åœºå…³ä¹å›½è¿çš„é£æš´æ­£åœ¨é…é…¿ã€‚</p>
      <p>çš‡å¸æœ±åšç†œå·²äºŒåä½™å¹´ä¸ä¸Šæœï¼Œæ·±å±…è¥¿è‹‘ï¼Œä¸€å¿ƒä¿®é“ç‚¼ä¸¹ã€‚æœæ”¿å¤§æƒæ—è½äºå†…é˜é¦–è¾…<span class="gold">ä¸¥åµ©</span>ä¹‹æ‰‹ã€‚ä¸¥å…šæŠŠæŒæœçº²ï¼Œè´ªå¢¨æˆé£ï¼Œå›½åº“ç©ºè™šã€‚</p>
      <p>ç„¶è€Œæš—æµä¹‹ä¸‹ï¼Œæ¬¡è¾…<span class="gold">å¾é˜¶</span>éŸ¬å…‰å…»æ™¦äºŒåå¹´ï¼Œåªå¾…ä¸€æœç¿»ç›˜ã€‚å¸ç¤¼ç›‘æŒå°å¤ªç›‘<span class="gold">å•èŠ³</span>åœ¨çš‡å¸ä¸ç¾¤è‡£ä¹‹é—´å°å¿ƒå‘¨æ—‹ã€‚è€Œä¸€ä¸ªå«<span class="gold">æµ·ç‘</span>çš„ä¸ƒå“çŸ¥å¿ï¼Œæ­£åœ¨å†™ä¸€å°è¶³ä»¥éœ‡åŠ¨å¤©ä¸‹çš„å¥ç–ã€‚</p>
      <p>ä½ â€”â€”<span class="gold">æ²ˆé»˜</span>ï¼Œç¿°æ—é™¢æ–°æ™‹ç¼–ä¿®ï¼Œå˜‰é–å››åå››å¹´æ®¿è¯•äºŒç”²ç¬¬ä¸ƒåã€‚å‡ºèº«å¯’é—¨ï¼Œæ‰å­¦è¿‡äººï¼Œå´å¯¹æœå ‚çš„æ³¢è°²äº‘è¯¡ä¸€æ— æ‰€çŸ¥ã€‚</p>
      <p>ä»Šæ—¥ï¼Œä½ ç¬¬ä¸€æ¬¡è¸å…¥ç´«ç¦åŸã€‚</p>
      <p class="center gold">å‘½è¿çš„é½¿è½®ï¼Œå¼€å§‹è½¬åŠ¨ã€‚</p>
      <button class="prologue-btn" onclick="startGame()">è¸ å…¥ ç´« ç¦ åŸ</button>
    </div>
  </div>

  <!-- ç« èŠ‚è¿‡æ¸¡ -->
  <div id="chapter-transition">
    <div class="ch-num" id="ch-num"></div>
    <div class="ch-title" id="ch-title"></div>
    <div class="ch-desc" id="ch-desc"></div>
  </div>

  <!-- ç»“å±€ç”»é¢ -->
  <div id="ending-screen">
    <div class="ending-label">â€”â€” ç»“ å±€ â€”â€”</div>
    <div class="ending-title" id="ending-title"></div>
    <div class="ending-desc" id="ending-desc"></div>
    <div class="ending-poem" id="ending-poem"></div>
    <button class="btn-start" onclick="location.reload()">é‡ æ–° å¼€ å§‹</button>
  </div>

  <!-- æ¸¸æˆä¸»ç•Œé¢ -->
  <div id="game-ui">
    <!-- çŠ¶æ€æ  -->
    <div id="status-bar">
      <div class="status-left">
        <span id="chapter-title">ç¬¬ä¸€ç« </span>
      </div>
      <div class="status-right">
        <div class="stat-item">
          <span class="stat-icon">âš”</span><span>æƒåŠ¿</span>
          <div class="stat-bar"><div class="stat-fill power" id="power-bar" style="width:20%"></div></div>
        </div>
        <div class="stat-item">
          <span class="stat-icon">ğŸ“–</span><span>æ™ºè°‹</span>
          <div class="stat-bar"><div class="stat-fill wisdom" id="wisdom-bar" style="width:30%"></div></div>
        </div>
        <div class="stat-item">
          <span class="stat-icon">ğŸ›</span><span>å¿ ä¹‰</span>
          <div class="stat-bar"><div class="stat-fill loyalty" id="loyalty-bar" style="width:50%"></div></div>
        </div>
        <button class="menu-btn" onclick="toggleRelPanel()">äººç‰©å…³ç³»</button>
      </div>
    </div>

    <!-- å…³ç³»é¢æ¿ -->
    <div id="relation-panel">
      <h4>äºº ç‰© å…³ ç³»</h4>
      <div id="rel-list"></div>
    </div>

    <!-- è§’è‰²ç«‹ç»˜åŒº -->
    <div id="character-area"></div>

    <!-- å¯¹è¯æ¡† -->
    <div id="dialogue-box" onclick="advanceDialogue()">
      <div id="speaker-name"></div>
      <div id="dialogue-text"></div>
      <div id="continue-hint">â–¼ ç‚¹å‡»ç»§ç»­</div>
    </div>

    <!-- é€‰é¡¹ -->
    <div id="choices-container">
      <h3>â€”â€” æŠ‰ æ‹© â€”â€”</h3>
      <div id="choices-list"></div>
    </div>
  </div>
</div>
<script>
// ===== æ¸¸æˆçŠ¶æ€ =====
const state = {
  chapter: 0, dialogueIdx: 0,
  stats: { power: 20, wisdom: 30, loyalty: 50 },
  relations: { 'ä¸¥åµ©': 30, 'å¾é˜¶': 40, 'å•èŠ³': 50, 'æµ·ç‘': 20, 'å˜‰é–å¸': 30 },
  typing: false, typingTimer: null, fullText: ''
};

// ===== å‰§æƒ…æ•°æ® =====
const chapters = [
  {
    title: 'åˆå…¥ç¿°æ—', desc: 'ç´«ç¦åŸçš„ç¬¬ä¸€å¤©', scene: 'scene-palace',
    dialogues: [
      { speaker: 'æ—ç™½', text: 'å˜‰é–å››åäº”å¹´è…Šæœˆåˆä¸‰ï¼Œä½ ç¬¬ä¸€æ¬¡è¸å…¥ç¿°æ—é™¢ã€‚ç©ºæ°”ä¸­å¼¥æ¼«ç€å¢¨é¦™ä¸ç‚­ç«çš„æ°”æ¯ã€‚' },
      { speaker: 'åŒåƒšå¼ å±…æ­£', text: 'ä½ ä¾¿æ˜¯ä»Šç§‘æ®¿è¯•äºŒç”²ç¬¬ä¸ƒåçš„æ²ˆé»˜ï¼Ÿä¹…ä»°ã€‚æˆ‘æ˜¯å¼ å±…æ­£ï¼Œåœ¨æ­¤ç¼–ä¿®å·²æœ‰æ•°å¹´ã€‚' },
      { speaker: 'æ²ˆé»˜', text: 'å¼ å…„å®¢æ°”äº†ã€‚åˆæ¥ä¹åˆ°ï¼Œè¿˜æœ›å¤šå¤šæŒ‡æ•™ã€‚' },
      { speaker: 'å¼ å±…æ­£', text: 'æŒ‡æ•™ä¸æ•¢å½“ã€‚åªæ˜¯æœ‰ä¸€å¥è¯è¦æé†’ä½ â€”â€”ç¿°æ—é™¢è™½æ˜¯æ¸…æ°´è¡™é—¨ï¼Œå´æ˜¯æœå ‚é£æš´çš„é£çœ¼ã€‚ä¸¥é˜è€ä¸å¾é˜è€ä¹‹äº‰ï¼Œä½ è¿Ÿæ—©è¦é¢å¯¹ã€‚' },
      { speaker: 'æ—ç™½', text: 'è¯éŸ³æœªè½ï¼Œé—¨å¤–ä¼ æ¥ä¸€é˜µå–§å“—ã€‚ä¸¥åµ©ä¹‹å­ä¸¥ä¸–è•ƒå¤§æ­¥èµ°å…¥ï¼Œèº«åè·Ÿç€å‡ åé”¦è¡£å«ã€‚' },
      { speaker: 'ä¸¥ä¸–è•ƒ', text: 'å“ªä¸ªæ˜¯æ–°æ¥çš„æ²ˆé»˜ï¼Ÿæˆ‘çˆ¶äº²è¯´è¦è§ä½ ã€‚ç¿°æ—é™¢çš„äººï¼Œæ€»è¯¥æ‡‚å¾—è§„çŸ©ã€‚' }
    ],
    choices: [
      { text: 'æ­æ•¬è¡Œç¤¼ï¼šã€Œä¸¥å…¬å­æœ‰å‘½ï¼Œä¸‹å®˜è‡ªå½“å‰å¾€ã€‚ã€', tag: 'åœ†æ»‘', effects: { power: 10, wisdom: 0, loyalty: -5, relations: { 'ä¸¥åµ©': 15 } } },
      { text: 'ä¸å‘ä¸äº¢ï¼šã€Œä¸¥å…¬å­ç¨å€™ï¼Œå®¹æˆ‘æ•´ç†æ‰‹ä¸­å…¬æ–‡ã€‚ã€', tag: 'æŒé‡', effects: { power: 0, wisdom: 10, loyalty: 5, relations: { 'å¾é˜¶': 10 } } },
      { text: 'å†·æ·¡å›åº”ï¼šã€Œç¿°æ—é™¢çš„è§„çŸ©ï¼Œæ˜¯ä¸ºæœå»·åŠå·®ã€‚ã€', tag: 'åˆšç›´', effects: { power: -5, wisdom: 5, loyalty: 15, relations: { 'æµ·ç‘': 15, 'ä¸¥åµ©': -10 } } }
    ]
  },
  {
    title: 'æš—æµæ¶ŒåŠ¨', desc: 'ä¹¦æˆ¿å¯†è°ˆ', scene: 'scene-study',
    dialogues: [
      { speaker: 'æ—ç™½', text: 'æ•°æ—¥åçš„æ·±å¤œï¼Œä¸€å°å¯†ä¿¡é€åˆ°ä½ çš„ä½å¤„ã€‚ä¿¡ä¸Šåªæœ‰å››ä¸ªå­—ï¼šã€Œå­æ—¶ï¼Œä¹¦æˆ¿ã€‚ã€è½æ¬¾æ˜¯ä¸€æšæ¢…èŠ±å°ã€‚' },
      { speaker: 'å¾é˜¶', text: 'æ²ˆé»˜ï¼Œè€å¤«è§‚ä½ æ•°æ—¥ï¼ŒçŸ¥ä½ éæ± ä¸­ä¹‹ç‰©ã€‚ä»Šå¤œè¯·ä½ æ¥ï¼Œæ˜¯æƒ³é—®ä½ ä¸€å¥è¯ã€‚' },
      { speaker: 'æ²ˆé»˜', text: 'å¾é˜è€è¯·è®²ã€‚' },
      { speaker: 'å¾é˜¶', text: 'ä¸¥åµ©çˆ¶å­æŠŠæŒæœæ”¿äºŒåå¹´ï¼Œå›½åº“äºç©ºï¼Œç™¾å§“å›°è‹¦ã€‚ä½ è§‰å¾—ï¼Œè¿™å¤§æ˜è¿˜æœ‰æ•‘å—ï¼Ÿ' },
      { speaker: 'æ—ç™½', text: 'çƒ›ç«æ‘‡æ›³ï¼Œå¾é˜¶çš„ç›®å…‰å¦‚é¹°éš¼èˆ¬é”åˆ©ã€‚ä½ çŸ¥é“ï¼Œè¿™ä¸ªå›ç­”å°†å†³å®šä½ åœ¨æœå ‚ä¸Šçš„ä½ç½®ã€‚' }
    ],
    choices: [
      { text: 'ã€Œå¤§æ˜è‡ªæœ‰æ°”è¿ï¼Œåªè¦åœ£ä¸Šè‹±æ˜ï¼Œè‡ªèƒ½æ‹¨ä¹±åæ­£ã€‚ã€', tag: 'ä¿å®ˆ', effects: { power: 5, wisdom: 5, loyalty: 5, relations: { 'å˜‰é–å¸': 10 } } },
      { text: 'ã€Œç§¯å¼Šå·²æ·±ï¼Œéé›·éœ†æ‰‹æ®µä¸èƒ½æŒ½å›ã€‚é˜è€è‹¥æœ‰å¤§è®¡ï¼Œæ²ˆé»˜æ„¿æ•ˆçŠ¬é©¬ã€‚ã€', tag: 'æŠ•è¯š', effects: { power: 10, wisdom: 5, loyalty: 0, relations: { 'å¾é˜¶': 20, 'ä¸¥åµ©': -10 } } },
      { text: 'ã€Œä¸‹å®˜åªæ˜¯ç¿°æ—ç¼–ä¿®ï¼Œä¸æ•¢å¦„è®®æœæ”¿ã€‚ä½†æ±‚æ— æ„§äºå¿ƒã€‚ã€', tag: 'ä¸­ç«‹', effects: { power: 0, wisdom: 10, loyalty: 10, relations: { 'å•èŠ³': 10 } } }
    ]
  },
  {
    title: 'æœå ‚é£æš´', desc: 'å¼¹åŠ¾ä¸¥åµ©', scene: 'scene-court',
    dialogues: [
      { speaker: 'æ—ç™½', text: 'å˜‰é–å››åäº”å¹´äºŒæœˆï¼Œå¾¡å²é‚¹åº”é¾™ä¸Šç–å¼¹åŠ¾ä¸¥ä¸–è•ƒè´ªå¢¨å†›é¥·ã€‚æœå ‚éœ‡åŠ¨ã€‚' },
      { speaker: 'å•èŠ³', text: 'æ²ˆç¼–ä¿®ï¼Œçš‡ä¸Šè®©æˆ‘æ¥é—®ä½ ä¸€å¥â€”â€”é‚¹åº”é¾™çš„å¥ç–ï¼Œä½ äº‹å…ˆçŸ¥æƒ…å¦ï¼Ÿ' },
      { speaker: 'æ²ˆé»˜', text: 'å•å…¬å…¬ï¼Œä¸‹å®˜â€¦â€¦' },
      { speaker: 'å•èŠ³', text: 'ä¸å¿…ç´§å¼ ã€‚çš‡ä¸Šä¸æ˜¯è¦æ²»ä½ çš„ç½ªã€‚åªæ˜¯æƒ³çŸ¥é“ï¼Œç¿°æ—é™¢é‡Œçš„å¹´è½»äººï¼Œåˆ°åº•ç«™åœ¨å“ªä¸€è¾¹ã€‚' },
      { speaker: 'æ—ç™½', text: 'å•èŠ³çš„è¯çœ‹ä¼¼éšæ„ï¼Œå´å­—å­—åƒé’§ã€‚å¸ç¤¼ç›‘æŒå°å¤ªç›‘çš„è¯•æ¢ï¼Œæ¯”ä»»ä½•åˆ€å‰‘éƒ½è¦å±é™©ã€‚' },
      { speaker: 'å•èŠ³', text: 'ä¸¥é˜è€è€äº†ï¼Œå¾é˜è€ä¹Ÿè€äº†ã€‚è¿™å¤©ä¸‹ï¼Œç»ˆç©¶æ˜¯ä½ ä»¬å¹´è½»äººçš„ã€‚ä½ æƒ³åšä»€ä¹ˆæ ·çš„äººï¼Ÿ' }
    ],
    choices: [
      { text: 'ã€Œä¸‹å®˜æ„¿åšçš‡ä¸Šçš„è€³ç›®ï¼Œä¸ºåœ£ä¸Šåˆ†å¿§ã€‚ã€', tag: 'ä¾é™„çš‡æƒ', effects: { power: 15, wisdom: 0, loyalty: -10, relations: { 'å˜‰é–å¸': 20, 'å•èŠ³': 15 } } },
      { text: 'ã€Œä¸‹å®˜åªæƒ³åšä¸€ä¸ªå¥½å®˜ï¼Œä¸ºç™¾å§“åšäº›å®äº‹ã€‚ã€', tag: 'æ¸…æµ', effects: { power: -5, wisdom: 10, loyalty: 15, relations: { 'æµ·ç‘': 20, 'å¾é˜¶': 10 } } },
      { text: 'ã€Œä¸‹å®˜æƒ³åšä¸€ä¸ªèƒ½æ´»åˆ°æœ€åçš„äººã€‚ã€', tag: 'åŠ¡å®', effects: { power: 5, wisdom: 15, loyalty: 0, relations: { 'å•èŠ³': 20 } } }
    ]
  },
  {
    title: 'ç”Ÿæ­»æŠ‰æ‹©', desc: 'æµ·ç‘ä¸Šç–', scene: 'scene-night',
    dialogues: [
      { speaker: 'æ—ç™½', text: 'å˜‰é–å››åäº”å¹´å†¬ï¼Œä¸€ä¸ªæ¶ˆæ¯åœ¨äº¬åŸæš—ä¸­æµä¼ â€”â€”æ·³å®‰çŸ¥å¿æµ·ç‘ï¼Œæ­£åœ¨å†™ä¸€å°ç›´è°çš‡å¸çš„å¥ç–ã€‚' },
      { speaker: 'æµ·ç‘', text: 'æ²ˆå…„ï¼Œæˆ‘å·²å¤‡å¥½æ£ºæã€‚è¿™å°ã€Šæ²»å®‰ç–ã€‹ï¼Œæ˜æ—¥ä¾¿è¦å‘ˆä¸Šã€‚' },
      { speaker: 'æ²ˆé»˜', text: 'æµ·å…„ï¼Œä½ å¯çŸ¥è¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿç›´è¨€å¤©å­è¿‡å¤±ï¼Œè‡ªå¤ä»¥æ¥â€¦â€¦' },
      { speaker: 'æµ·ç‘', text: 'è‡ªå¤ä»¥æ¥ï¼Œå¿ è‡£ä¸æ€•æ­»ã€‚æˆ‘æµ·ç‘è¯»åœ£è´¤ä¹¦ï¼Œæ‰€å­¦ä½•äº‹ï¼Ÿè‹¥è¿çœŸè¯éƒ½ä¸æ•¢è¯´ï¼Œæ‰ä¸ºäººè‡£ã€‚' },
      { speaker: 'æ—ç™½', text: 'æµ·ç‘å°†ä¸€ä»½å¥ç–å‰¯æœ¬é€’ç»™ä½ ã€‚ä½ å±•å¼€ä¸€çœ‹ï¼Œåªè§‰å­—å­—å¦‚åˆ€â€”â€”ç›´æ–¥å˜‰é–å¸äºŒåå¹´ä¸ä¸Šæœã€æ²‰è¿·ä¿®é“ã€ä»»ç”¨å¥¸ä½ã€‚' },
      { speaker: 'æµ·ç‘', text: 'æ²ˆå…„ï¼Œæˆ‘åªæ±‚ä½ ä¸€ä»¶äº‹ã€‚è‹¥æˆ‘æ˜æ—¥ä¸‹ç‹±ï¼Œè¯·å°†è¿™ä»½å‰¯æœ¬ä¿å­˜å¥½ã€‚æ€»æœ‰ä¸€å¤©ï¼Œå¤©ä¸‹äººä¼šçŸ¥é“çœŸç›¸ã€‚' }
    ],
    choices: [
      { text: 'æ¥è¿‡å‰¯æœ¬ï¼šã€Œæµ·å…„æ”¾å¿ƒï¼Œæ²ˆæŸä»¥æ€§å‘½æ‹…ä¿ã€‚ã€', tag: 'ä¹‰æ°”', effects: { power: -10, wisdom: 5, loyalty: 20, relations: { 'æµ·ç‘': 30, 'å˜‰é–å¸': -15 } } },
      { text: 'åŠé˜»æµ·ç‘ï¼šã€Œæµ·å…„ä¸‰æ€ï¼Œç•™å¾—é’å±±åœ¨ï¼Œä¸æ€•æ²¡æŸ´çƒ§ã€‚ã€', tag: 'åŠè°', effects: { power: 5, wisdom: 10, loyalty: 5, relations: { 'æµ·ç‘': -10, 'å•èŠ³': 10 } } },
      { text: 'æ²‰é»˜ä¸è¯­ï¼Œèµ·èº«ç¦»å»ã€‚', tag: 'è‡ªä¿', effects: { power: 10, wisdom: 5, loyalty: -15, relations: { 'æµ·ç‘': -20, 'ä¸¥åµ©': 10 } } }
    ]
  },
  {
    title: 'ç»ˆå±€', desc: 'å‘½è¿çš„å®¡åˆ¤', scene: 'scene-court',
    dialogues: [
      { speaker: 'æ—ç™½', text: 'å˜‰é–å››åäº”å¹´è…Šæœˆï¼Œä¸¥åµ©ç»ˆäºå€’å°ã€‚ä¸¥ä¸–è•ƒè¢«æ–©äºè¥¿å¸‚ï¼Œä¸¥åµ©å‰Šç±ä¸ºæ°‘ã€‚æµ·ç‘ä¸‹ç‹±åå¤©ä¸‹éœ‡åŠ¨ï¼Œå˜‰é–å¸è™½æ€’å´ä¸æ•¢æ€ä»–ã€‚' },
      { speaker: 'æ—ç™½', text: 'è€Œä½ â€”â€”æ²ˆé»˜ï¼Œåœ¨è¿™åœºé£æš´ä¸­èµ°è¿‡äº†æœ€å…³é”®çš„ä¸€å¹´ã€‚ä½ çš„æ¯ä¸€ä¸ªé€‰æ‹©ï¼Œéƒ½åœ¨æ— å£°ä¸­å¡‘é€ ç€ä½ çš„å‘½è¿ã€‚' },
      { speaker: 'å¼ å±…æ­£', text: 'æ²ˆå…„ï¼Œæ–°æœå°†è‡³ã€‚ä½ æˆ‘è¿™ä¸€ä»£äººï¼Œç»ˆäºç­‰åˆ°äº†æ–½å±•æŠ±è´Ÿçš„æ—¶å€™ã€‚' },
      { speaker: 'æ—ç™½', text: 'ä½ ç«™åœ¨ç´«ç¦åŸçš„åŸå¢™ä¸Šï¼Œæœ›ç€è¿œæ–¹ã€‚å¤§æ˜çš„å¤©ç©ºï¼Œä¼¼ä¹æ¯”ä¸€å¹´å‰æ›´äº®äº†ä¸€äº›ã€‚' }
    ],
    choices: null
  }
];

// ===== DOM =====
const $ = id => document.getElementById(id);
const sceneBg=$('scene-bg'), titleScreen=$('title-screen'), prologueScreen=$('prologue-screen');
const gameUI=$('game-ui'), chapterTransition=$('chapter-transition'), endingScreen=$('ending-screen');
const speakerName=$('speaker-name'), dialogueText=$('dialogue-text'), continueHint=$('continue-hint');
const choicesContainer=$('choices-container'), choicesList=$('choices-list');
const relPanel=$('relation-panel'), relList=$('rel-list'), canvas=$('particles');

// ===== ç²’å­ =====
const ctx = canvas.getContext('2d');
let particles = [];
function resizeCanvas(){canvas.width=innerWidth;canvas.height=innerHeight}
addEventListener('resize',resizeCanvas); resizeCanvas();
function mkP(){return{x:Math.random()*canvas.width,y:canvas.height+10,s:Math.random()*2+.5,sp:Math.random()*.5+.2,o:Math.random()*.5+.2,d:(Math.random()-.5)*.3}}
for(let i=0;i<30;i++){const p=mkP();p.y=Math.random()*canvas.height;particles.push(p)}
(function anim(){ctx.clearRect(0,0,canvas.width,canvas.height);particles.forEach((p,i)=>{p.y-=p.sp;p.x+=p.d;if(p.y<-10)particles[i]=mkP();ctx.beginPath();ctx.arc(p.x,p.y,p.s,0,Math.PI*2);ctx.fillStyle=`rgba(201,168,76,${p.o})`;ctx.fill()});requestAnimationFrame(anim)})();

// ===== æ ¸å¿ƒ =====
function showPrologue(){titleScreen.style.display='none';prologueScreen.style.display='block'}
function startGame(){titleScreen.style.display='none';prologueScreen.style.display='none';gameUI.style.display='block';state.chapter=0;state.dialogueIdx=0;updateStats();updateRelations();showChapterTransition(chapters[0])}
function showChapterTransition(ch){const i=state.chapter;$('ch-num').textContent=`ç¬¬${['ä¸€','äºŒ','ä¸‰','å››','äº”'][i]}ç« `;$('ch-title').textContent=ch.title;$('ch-desc').textContent=ch.desc;chapterTransition.style.display='flex';chapterTransition.style.opacity='0';setTimeout(()=>{chapterTransition.style.transition='opacity 0.8s';chapterTransition.style.opacity='1'},50);setTimeout(()=>{chapterTransition.style.opacity='0';setTimeout(()=>{chapterTransition.style.display='none';$('chapter-title').textContent=`ç¬¬${['ä¸€','äºŒ','ä¸‰','å››','äº”'][i]}ç«  Â· ${ch.title}`;sceneBg.className=ch.scene;state.dialogueIdx=0;showCurrent()},600)},2200)}
function showCurrent(){const ch=chapters[state.chapter];if(state.dialogueIdx>=ch.dialogues.length){if(ch.choices)showChoices(ch.choices);else checkEnding();return}const d=ch.dialogues[state.dialogueIdx];choicesContainer.style.display='none';$('dialogue-box').style.display='block';speakerName.textContent=d.speaker==='æ—ç™½'?'':d.speaker;typeText(d.text)}
function typeText(t){state.fullText=t;state.typing=true;dialogueText.innerHTML='';continueHint.classList.remove('show');let i=0;clearInterval(state.typingTimer);state.typingTimer=setInterval(()=>{if(i<t.length){const s=document.createElement('span');s.className='char';s.textContent=t[i];s.style.animationDelay='0s';dialogueText.appendChild(s);i++}else{clearInterval(state.typingTimer);state.typing=false;continueHint.classList.add('show')}},45)}
function advanceDialogue(){if(state.typing){clearInterval(state.typingTimer);dialogueText.textContent=state.fullText;state.typing=false;continueHint.classList.add('show');return}state.dialogueIdx++;showCurrent()}
function showChoices(choices){$('dialogue-box').style.display='none';choicesContainer.style.display='block';choicesList.innerHTML='';choices.forEach(c=>{const b=document.createElement('button');b.className='choice-btn';b.innerHTML=`${c.text}<span class="choice-tag">${c.tag}</span>`;b.onclick=()=>applyChoice(c.effects);choicesList.appendChild(b)})}
function applyChoice(e){['power','wisdom','loyalty'].forEach(k=>{if(e[k])state.stats[k]=Math.max(0,Math.min(100,state.stats[k]+e[k]))});if(e.relations)for(const[k,v]of Object.entries(e.relations))if(state.relations[k]!==undefined)state.relations[k]=Math.max(0,Math.min(100,state.relations[k]+v));updateStats();updateRelations();choicesContainer.style.display='none';state.chapter++;if(state.chapter>=chapters.length){checkEnding();return}showChapterTransition(chapters[state.chapter])}
function updateStats(){$('power-bar').style.width=state.stats.power+'%';$('wisdom-bar').style.width=state.stats.wisdom+'%';$('loyalty-bar').style.width=state.stats.loyalty+'%'}
function updateRelations(){relList.innerHTML='';for(const[n,v]of Object.entries(state.relations)){const d=document.createElement('div');d.className='rel-item';const c=v>=60?'high':v<=30?'low':'';d.innerHTML=`<span class="rel-name">${n}</span><span class="rel-value ${c}">${v}</span>`;relList.appendChild(d)}}
function toggleRelPanel(){relPanel.style.display=relPanel.style.display==='none'?'block':'none'}
function checkEnding(){const{power:p,wisdom:w,loyalty:l}=state.stats;let t,d,m;if(p>=w&&p>=l){t='æƒå€¾æœé‡';d='ä½ åœ¨æœå ‚çš„åšå¼ˆä¸­æ­¥æ­¥ä¸ºè¥ï¼Œæœ€ç»ˆæˆä¸ºæ–°æœçš„æ ¸å¿ƒäººç‰©ã€‚æƒåŠ›åœ¨æ¡ï¼Œå´ä¹Ÿèº«ä¸ç”±å·±ã€‚ä½ æœ›ç€ç´«ç¦åŸçš„è½æ—¥ï¼Œæƒ³èµ·äº†å½“å¹´é‚£ä¸ªåˆå…¥ç¿°æ—çš„å°‘å¹´ã€‚';m='ä¸€æœæƒåœ¨æ‰‹\nä¾¿æŠŠä»¤æ¥è¡Œ\nå›é¦–æ¥æ—¶è·¯\nå·²éæ˜¨æ—¥äºº'}else if(w>=p&&w>=l){t='é’å²ç•™å';d='ä½ ä»¥è¿‡äººçš„æ™ºæ…§åœ¨æœå ‚ä¸­æ¸¸åˆƒæœ‰ä½™ï¼Œæ—¢ä¿å…¨äº†è‡ªèº«ï¼Œåˆæ¨åŠ¨äº†æ”¹é©ã€‚åä¸–å²ä¹¦è¯„ä»·ä½ ï¼šã€Œæ²ˆé»˜è€…ï¼Œæ˜ä¹‹èƒ½è‡£ä¹Ÿã€‚ä¸äº‰ä¸€æ—¶ä¹‹åŠŸï¼Œè€Œè°‹ä¸‡ä¸–ä¹‹åˆ©ã€‚ã€';m='ä¸äº‰æœå¤•åŠŸ\nä½†è°‹å¤©ä¸‹åˆ©\né’å²å‡ è¡Œå­—\nåƒç§‹è‡ªæœ‰è¯„'}else{t='ä¸¹å¿ƒç…§æ±—é’';d='ä½ é€‰æ‹©äº†æœ€è‰°éš¾çš„é“è·¯â€”â€”åšä¸€ä¸ªå¿ è‡£ã€‚ä½ ä¸æµ·ç‘å¹¶è‚©è€Œç«‹ï¼Œç›´è¨€è¿›è°ï¼Œè™½å±¡é­è´¬è°ªï¼Œå´èµ¢å¾—äº†å¤©ä¸‹äººçš„æ•¬é‡ã€‚';m='ç²‰èº«ç¢éª¨æµ‘ä¸æ€•\nè¦ç•™æ¸…ç™½åœ¨äººé—´\næ­¤å¿ƒå…‰æ˜\näº¦å¤ä½•è¨€'}gameUI.style.display='none';endingScreen.style.display='flex';endingScreen.style.opacity='0';$('ending-title').textContent=t;$('ending-desc').textContent=d;$('ending-poem').textContent=m;setTimeout(()=>{endingScreen.style.transition='opacity 1.5s';endingScreen.style.opacity='1'},100)}
</script>
</body>
</html>